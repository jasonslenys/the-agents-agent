generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         String   @default("owner") // "owner", "agent"
  isAdmin      Boolean  @default(false) // Platform admin flag
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relationships
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId     String
  assignedLeads Lead[]  @relation("AssignedLeads")

  @@map("users")
}

model Tenant {
  id                   String   @id @default(cuid())
  name                 String
  averageCommission    Float?   @default(5000) // Average commission in dollars
  estimatedDealRate    Float?   @default(0.10) // 10% deal conversion rate
  
  // Notification settings
  emailNotificationsEnabled Boolean? @default(false)
  additionalNotificationEmails String? // Comma-separated email list
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relationships
  users         User[]
  widgets       Widget[]
  leads         Lead[]
  conversations Conversation[]
  events        WidgetEvent[]
  invitations   TeamInvitation[]

  @@map("tenants")
}

model Widget {
  id           String   @id @default(cuid())
  name         String
  greetingText String   @default("Hello! How can I help you with your real estate needs today?")
  primaryColor String   @default("#0ea5e9")
  isActive     Boolean  @default(true)
  publicKey    String   @unique @default(cuid())
  position     String   @default("bottom-right") // bottom-right, bottom-left, top-right, top-left
  bubbleText   String   @default("Chat with my AI assistant")
  agentName    String?
  companyName  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relationships
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId      String
  leads         Lead[]
  conversations Conversation[]
  events        WidgetEvent[]

  @@map("widgets")
}

model Lead {
  id                String   @id @default(cuid())
  name              String?
  email             String?
  phone             String?
  intent            String?
  qualificationScore Float?  @default(0)
  notes             String?
  assignedUserId    String?  // User assigned to handle this lead
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relationships
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId      String
  widget        Widget         @relation(fields: [widgetId], references: [id], onDelete: Cascade)
  widgetId      String
  assignedUser  User?          @relation("AssignedLeads", fields: [assignedUserId], references: [id], onDelete: SetNull)
  conversations Conversation[]

  @@map("leads")
}

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId String
  widget   Widget    @relation(fields: [widgetId], references: [id], onDelete: Cascade)
  widgetId String
  lead     Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  leadId   String?
  messages Message[]

  @@map("conversations")
}

model Message {
  id         String      @id @default(cuid())
  text       String
  senderType String      // "VISITOR", "AGENT", or "SYSTEM"
  createdAt  DateTime    @default(now())
  
  // Relationships
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String

  @@map("messages")
}

model WidgetEvent {
  id        String   @id @default(cuid())
  eventType String   // "widget_view", "conversation_started", "lead_created"
  sessionId String?  // Optional session identifier for tracking unique visitors
  userAgent String?  // Browser user agent
  referrer  String?  // Page where widget was loaded
  createdAt DateTime @default(now())
  
  // Relationships
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId String
  widget   Widget @relation(fields: [widgetId], references: [id], onDelete: Cascade)
  widgetId String

  @@index([tenantId, eventType])
  @@index([widgetId, eventType])
  @@index([createdAt])
  @@map("widget_events")
}

model TeamInvitation {
  id           String   @id @default(cuid())
  email        String
  role         String   @default("agent") // "agent" or "owner"
  token        String   @unique @default(cuid())
  status       String   @default("pending") // "pending", "accepted", "expired"
  invitedBy    String   // User ID who sent the invitation
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relationships
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId     String

  @@unique([email, tenantId, status])
  @@map("team_invitations")
}
